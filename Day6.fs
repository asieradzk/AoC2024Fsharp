module day6

open System


let input = "....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#..."


let actualInput = ".#..#......................#........#........................................#.............#......#...............#...............
.......#...........#........................#..............#.....#......#..##............#.....#.....................##...........
.#.....#........#.##..#.............#...........#................#............#.#.........#.....................#......#..........
...........#...#.#.................................#.....................#............#.....#.#................#..#...............
..................................................................................#...............................................
..................#....................#.................#.........#..#.................#...........#...................#.........
.......#......#................#.......#............................#.................#.........................#...#........#....
................................#..............................................................#.........#.........#..............
.......................................................#............#......#........#.#...................#............#..........
.....#......#..............................................#..............................................#.......................
......#..........................................................................................#................#...............
............................#..................#............#..#.#..............#..........#......................................
......#..........................#...................#..........#....#.........................#.......................#....#..#..
..................................#..........#....................................................................#........#......
..#.................................#..................................................#......................#...................
.....#............#..................#......#...................................#.#........#.#......#........#....................
........#......................#.....#...#.##................................#......#.............................................
...........#.........#...............................................................................#............................
..................................#...##...............................#.............#.........................................##.
..........................#.#..#......................................#........#..............................#...................
......#...........###..#....#........................................................................................#............
..............#.....................................................................#......##.............#.......................
.................................#...................#.........#..............................................#...........#.......
....................#..#...................................................#................................#........#............
........................................#.#.#..................#....................#.....#.................#.....................
.........................#....#.....#.................##...............................................#.......#...#..............
..#.........................#....................#.........................#..............................#...................#...
..................##....#..#..#.#.................................................................#...............................
..............#........................................................#.............................#......#.....................
.................#...........#........................#......#..........##....................#.................................#.
..........................#.............................................#..#.................................#.........#...#......
..#..................##.....................................................#.....................#.......#.....#.................
....#.........................................#..................#.#.........................#.......................#............
...#.....#.#..............................................................#................#......................#...#........#..
.............................#..#......#.....................................................##...................................
...........#......................#....#.........#........................#......................................................#
............#.............................................#.................................#....#................................
..............................................................#.............#................#.........#.........................#
..........................................#....#........#......................#.....#.............#..............................
..#..#.............#...............................................#.....................................................#........
................................................................................#.............#...................................
...............................................#.......................#................#............#....................#.#.....
.......................#.............................#.#..................#...#....#.................................#...#.....#..
.......................#...........................#.........................................#.........#.........................#
...#.........#.....#..........................................#...................................................................
..........#..#...#...#........................#..........#..........................................#......#.........#............
...............#............................#.#...................##.....................................................#........
.........................................................#....................#........................#.........#....##....#...#.
......................................#.#................................................#........................#...............
..........#.............................................................#..#..#..............................#...#...#.#..........
.........#.....................................................................................#...........#..#......#..........#.
............................#....................#..............#...#.............................................................
...........................................................#........#......................#.................................#....
.........#..................#.........#.......#...............................#................#.............#...........#........
............................#.........#...........................................................................................
................................#...........#.......................................#..........#.#.....#..........................
..........................................#.................................................................................#.....
..............#...............................................#...................................................................
...#....#.....................#..........#..#......................#..............................................................
.......................#..........#.................................................#......#.............#........#....#..........
.........................................................................#.#......................................#...............
..........................................#.......................#...............................................#.........#...#.
............................#.......................................................#...#.........#..#...##........#..............
...........................................................................#..............#..........#.............#..............
#............#..#...#..#........#....................#...........#..#.........................................#..........#........
...........................................................................#......#..^.........#.........#........................
......#............................#.............................................................................................#
......................#.....#.......................................................#........................#..........#.........
................#....#.......#.............................#..............#....................#....#....................#........
......#...................................#..................................................................#....................
.....#..............#.#...........................................................#.................#.........#......#........#...
..#..#..#..#........#...........#...........#....##...........#.....................#.............................................
......................##..........................................................................................................
...........#............#.........................................................#.....#.....#....................#..............
#.............#..........#...............#..#.......................................#..............................#..............
#.......................................#........#....#.......................................................#..#.............#..
.......................#...#.....#..#...........................#...........#.........................#...#...#................#..
#...............................................................#........................................#.....................#..
..#.....................#............................##..........#..................##...#.....................................#..
.......#...................##..........................................#........#.................................................
.........................................................#............................................#...............##..........
.......................#......#..............................................................................................#....
...........#.......................................#.................................#..........#.............#..................#
....#.............#......#............................#........................#...................#......#.....#..........#......
.................................................................#................................#...............................
..........................................................#.......................#...#...........................................
.#............#...........................................#............................#..............................#...#.#.....
..#.................................................#.............................................#.....................#.........
.....#...............#...#.......................#.......................#......................................#...........#.....
...........#...#................................#.............................#........#.........................................#
..............................#.....................#......................#...#................................#.................
.........#.....................................................#...#......................................#................#......
.....#.....................#.................................#...................................................#....#......#....
................#.........#.........................#...........#...#..............................................#..............
.................................#....................................................................#..................#......#.
#..............#......................................................................#.....#.....................................
.............#......#..............##.#............#.#.....................#..........#.......#..........................#........
.......#............#.................#...........................................................#.............................#.
...........................#.......................#..................#....#....................................#.................
....#.....##...........................................#...........#.............#........................#.....#.................
............................#..............................................##..........#..................#.......#...............
#.............................#.............#...............................#..........#...#.....................................#
.............#.......#.....................................#...###......##...............#..#..............#.........#............
.......#......##.....#..................#....................................#............#................#...................#..
..............#......................#............#........#.....................................................#.........#....#.
.............#.......#...............................................##......#...........#...........#............................
#.#....#..............................................................#.........................................#...............#.
...#....#........................#.#.......#.....................#.............................#.#......................#.#.......
.##........................................................#.#...................#.....#.................................#........
............................#.#..................................#....#...........................................................
..................................................#......#...............#...............................#..#..#.......#..........
..........#......................#..........#.........................#...............#..##.....................#.................
...#.......#.........................................................#............#.........#...#................................#
....................#...................................#..........#.....#...#..#........#............#................#..........
...............................#........#.....................................#.....................................#.........#...
....#....................#...................................#.#........................#.........................................
.........#............................#.....................#.............#...........##.........#................................
.............................................##........................................#......#................................#..
...#...............................#.#...#...........#.............................#.............................................#
.............................#...........#................#..................................................#............#.......
................#....................................................................................#..#.#.......................
...#.............#.#..#.......................#.................#...............#..#....#..............#............#......#......
...........#......#............................#.....#..........#.#.................#..........#...........#...............#...#..
....#..................#...........................#.........#............#........#..........#..............................#....
..........#.......#...................#......#.......#.......#....................#.....................................#.........
...#....................................................#......#...#...................#.....................#....................
....................#..#.....#......#...................#............#.......................................#...............#....
.........................#.......#.....#..#.......#...........#......##..............................#.........#..................
.#...........#...#.........#....#...#.......#....#........................#...................#...#..................#............
.........##......#..............................#....................#..#...#..................#............................#....."


type Direction = 
    | North
    | East
    | South
    | West

type Tile = {
    mutable visited: bool
    visitedDirections: Direction ResizeArray
    value: char 
}

type Grid = Tile[,]


type Marker = {
    current: (int * int)
    direction: Direction
}

let lines = actualInput.Split('\n') |> Array.map (fun x -> x.Trim())
let width = lines |> Array.head |> String.length
let height = lines.Length
let mutable startPosition: int * int = (0, 0)

let grid = Array2D.init height width (fun i j -> 
    let value = lines.[i].[j]
    if value = '^' then
        startPosition <- (i, j)
        { visited = true; value = '.'; visitedDirections = ResizeArray([North])}
    else 
        { visited = false; value = value; visitedDirections = ResizeArray() }
)

let marker = { current = startPosition; direction = North }

let move (marker: Marker) = 
    match marker.direction with
    | North -> (fst marker.current - 1, snd marker.current)
    | East -> (fst marker.current, snd marker.current + 1)
    | South -> (fst marker.current + 1, snd marker.current)
    | West -> (fst marker.current, snd marker.current - 1)

let obstacle (marker: Marker) (grid: Grid) = 
    let (x, y) = move marker
    grid.[x, y].value = '#'

let turnClockwise (marker: Marker) = 
    let newDirection = 
        match marker.direction with
        | North -> East
        | East -> South
        | South -> West
        | West -> North
    { marker with direction = newDirection }

let outOfBounds (marker: Marker) = 
    let (x, y) = move marker
    x < 0 || x >= height || y < 0 || y >= width


let rec walk (marker: Marker) (grid: Grid) =
    if outOfBounds marker then
        ()
    else
        let (x, y) = move marker
        if grid.[x , y].value = '#'
        then
            let newMarker = turnClockwise marker
            walk newMarker grid
        else
            grid.[x, y].visited <- true
            walk { marker with current = (x, y) } grid


let countVisited (grid: Grid) =
    let mutable count = 0
    for x in 0 .. Array2D.length1 grid - 1 do
        for y in 0 .. Array2D.length2 grid - 1 do
            if grid.[x,y].visited then
                count <- count + 1
    count

walk marker grid
let count = countVisited grid

printfn "%A" count


//pt2

let rec isLoop (marker: Marker) (grid: Grid) =
    if outOfBounds marker then
        false
    else
        let (x, y) = move marker
        if grid.[x , y].value = '#'
        then
            let newMarker = turnClockwise marker
            isLoop newMarker grid
        else
            if grid.[x, y].visited && grid.[x, y].visitedDirections |> Seq.contains marker.direction then
                true
            else
                grid.[x, y].visited <- true
                grid.[x, y].visitedDirections.Add(marker.direction)
                isLoop { marker with current = (x, y) } grid

let getNextXY (x: int) (y: int) =
    if y + 1 < width then
        (x, y + 1) 
    else if x + 1 < height then
        (x + 1, 0) 
    else
        (-1, -1)

let resetGrid (grid: Grid) =
    for i in 0..Array2D.length1 grid - 1 do
        for j in 0..Array2D.length2 grid - 1 do
            grid.[i,j].visited <- false
            grid.[i,j].visitedDirections.Clear()
    


let rec countPossibleLoops (grid: Grid) (X: int) (Y: int) (sum: int) =
    let nextX, nextY = getNextXY X Y
    if X = -1 then
        sum

    else
        //reset grid
        resetGrid grid
        //reset marker
        let marker = { current = startPosition; direction = North }
        //change currentGrid to '#' and test for loop
        let originalTile = grid.[X, Y]
        grid.[X, Y] <- { originalTile with value = '#' }
        let isLoop = isLoop marker grid
        grid.[X, Y] <- originalTile

        if isLoop then
            countPossibleLoops grid nextX nextY (sum + 1)
        else
            countPossibleLoops grid nextX nextY sum


let countpt2 = countPossibleLoops grid 0 0 0

printfn "%A" countpt2
